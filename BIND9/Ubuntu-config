#create the zone file -start of authority, mail info, and name records
sudo nano /etc/bind/db.Eitan.itlab.com



$TTL    3600                       ; Default Time-To-Live for records
@       IN      SOA     ns1.Eitan.itlab.com. admin.Eitan.itlab.com. (
                        2025011401 ; Serial (YYYYMMDD##)
                        3600       ; Refresh (1 hour)
                        1800       ; Retry (30 minutes)
                        604800     ; Expire (1 week)
                        86400 )    ; Minimum TTL (1 day)

        IN      NS      ns1.Eitan.itlab.com.  ; Authoritative name server
ns1     IN      A       192.168.255.56        ; DNS server (Ubuntu)
R1      IN      A       192.168.255.190       ; Router
Sw      IN      A       192.168.255.57        ; Switch
Ubuntu  IN      A       192.168.255.56        ; Ubuntu server (also DNS server)
dns     IN      CNAME   Ubuntu                ; DNS alias pointing to Ubuntu


#added the zone configuration in BIND, Informs the BIND server about your zone and where to find its configuration file
sudo nano /etc/bind/named.conf.local

zone "Eitan.itlab.com" {
    type master;
    file "/etc/bind/db.Eitan.itlab.com.signed";
    dnssec-policy default;
    inline-signing yes;
};

#This file defines global options for the BIND server, including DNSSEC validation and recursion settings.
sudo nano /etc/bind/named.conf.options

acl trustedclients {
    localhost;                 // Allow localhost (127.0.0.1)
    localnets;                 // Allow all local networks
    192.168.255.0/24;          // Explicitly allow this subnet
};

options {
    directory "/var/cache/bind";    // Default working directory for BIND
    dnssec-validation auto;        // Enable automatic DNSSEC validation
    forwarders {
        1.1.1.1;                   // Cloudflare DNS
        1.0.0.1;                   // Cloudflare secondary DNS
    };

    allow-recursion { trustedclients; };  // Allow recursion for trusted clients

    listen-on port 53 { 192.168.255.56; 127.0.0.1; };  // Bind to specific IPv4 address
    listen-on-v6 port 53 { ::1; };          // Bind to localhost for IPv6
};
------------------------------------------------------------------------------------------------------
#explaination:

#acl trustedclients:                  Defines which clients are allowed to perform recursive queries.
#dnssec-validation auto:              Ensures that DNSSEC signatures are validated for all queries.
#forwarders:                          Specifies external DNS servers (e.g., Cloudflare) for queries that cannot be resolved locally.
#allow-recursion { trustedclients; }: Restricts recursive queries to trusted clients only.
#listen-on and listen-on-v6:          Configures which IP addresses BIND listens on for DNS queries.
#directory "/var/cache/bind";:        Sets the working directory where runtime files are stored.
#dnssec-policy default:               Applies the default DNSSEC policies, simplifying DNSSEC configuration.
--------------------------------------------------------------------------------------------------------

sudo systemctl restart bind9
sudo named-checkconf #Verify the global configuration

dig R1.Eitan.itlab.com @127.0.0.1 # test 127.0.0.1 is the ubuntu machine(loopback interface)

sudo dnssec-keygen -a RSASHA256 -b 1024 -n ZONE Eitan.itlab.com                             # generate ZSK (Zone Signing Key): Signs individual records (e.g., A, NS).
sudo dnssec-keygen -a RSASHA256 -b 2048 -n ZONE -f KSK Eitan.itlab.com                      # generate KSK (Key Signing Key): Signs the DNSKEY record set, which includes both the ZSK and KSK

sudo chown bind:bind /etc/bind/K*.key /etc/bind/K*.private
sudo chmod 600 /etc/bind/K*.key /etc/bind/K*.private

sudo nano file.sh #create a bash scripts that adds two lines in the end of the zone file: include (public key's file name ) 

"#!/bin/bash

for key in `ls /etc/bind/K*.key`
do
    echo "\$INCLUDE $key" >> /etc/bind/db.Eitan.itlab.com
done" 

sudo chmod +x file.sh                # add permission to execute
sudo ./file.sh                       # execute

 sudo dnssec-signzone -A -3 $(head -c 1000 /dev/random | sha1sum | cut -b 1-16)\         #generates a signed zone file
 -N INCREMENT -o Eitan.itlab.com -t -K /etc/bind /etc/bind/db.Eitan.itlab.com

sudo nano /etc/bind/named.conf.local                                                     # change the files path to the signed zone

zone "Eitan.itlab.com" {
    type master;
    file "/etc/bind/db.Eitan.itlab.com.signed";
    dnssec-policy default;
    inline-signing yes;
    key-directory "/etc/bind";
};

sudo systemctl restart bind9 #apply changes and check global configuration
sudo named-checkconf
sudo named-checkzone Eitan.itlab.com /etc/bind/db.Eitan.itlab.com.signed                 #verify the integrity of the signed zone file

